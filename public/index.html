<!DOCTYPE html>
<html>
<head>
  <title>Audio Recorder</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="shortcut icon" href="#">
  <link rel="stylesheet" type="text/css" href="./styles/styles.css">
</head>
<body style="display: flex;  background: linear-gradient(#4671EA, #AC34E7);height: fit-content;min-height: 100vh;">
  <section style="min-width: 175px;max-width: 175px;border-right: solid;display: flex;flex-direction: column; margin: -10px -10px -8px; padding: 8px;background-color: #302f2f;position:fixed;height: -webkit-fill-available;">
    <button id="voicePageButton">Voice</button>
    <button id="chatPageButton">Text</button>
    <button id="settingsButton">Settings</button>
    <section id="settings"style="display: none; flex-direction: column;">
    <div>
      <label for="voices" style="color:white">Choose A Voice:</label> 
      <br>
      <select name="voices" id="voices"> 
          <option value="discovery">Butler</option> 
          <option value="dave">Dave</option> 
          <option value="hannah">Hannah</option> 
          <option value="sam">Sam</option> 
          <option value="oldMan">Old Rich Man</option> 
      </select>
    </div>
    <label style="color:white"> Token Amount:<br><input type="number" min="25" max="300" class="tokenAmount" value="100"/></label>
    <label style="color:white">Chat Prompt:<input type="text" class="chatPrompt"/></label>
    <button id="sendData">Send data</button>
  </section>
  </nav>
</section>
  <section id="voicePage" style="padding-left:16%;">
    <section class="alignButtons">
      <div class="flexColumn">
        <button id="recordButton" class="button">Hold To Record</button>
        <!-- <button id="stop" class="button" disabled>Stop</button> -->
      </div>
      <div style="align-self: center;">
        <button id="playAI" class="aiButton1" disabled>
          <span class="aiButton1__text">Play AI Response</span></button>
      </div>
    </section>
    <audio id="player"></audio>
    <audio id="aiResponsePlayer"></audio>
</section>
<section id="chatPage" style="width: -webkit-fill-available;display: none; padding-left: 250px;">
  <div id="chatbox" style="width: 75%;padding: 0 5.5% 125px 5%;">
    <p id="chatContent" ></p>
  </div>
  <div class="wrapper">
    <textarea id="userInput" placeholder="Send a message" required></textarea>
    <button id="sendText" style="width: 40px;">></button>
  </div>
</section>



  <script>
    // require('dotenv').config();
    const audio = document.querySelector('#aiResponsePlayer');
    const chatbox = document.getElementById('chatbox');
    const chatPageButton = document.getElementById('chatPageButton');
    const voicePageButton = document.getElementById('voicePageButton');
    const chatPage = document.getElementById('chatPage');
    const voicePage = document.getElementById('voicePage');
    const textarea = document.querySelector("textarea")
    const settingsButton = document.getElementById('settingsButton');
    const settings = document.getElementById("settings")
    const chatContent = document.getElementById('chatContent');
    const userInput = document.getElementById('userInput');
    const sendText = document.getElementById('sendText');
    const recordButton = document.querySelector('#recordButton');
    settings.style.display="none"
    let dropdownList = document.getElementById('voices');
      dropdownList.onchange = (ev) =>{
      console.log("Selected value is: " + dropdownList.value);
    }

    let mediaRecorder;
    let recordedChunks = [];
    const btn = document.querySelector(".aiButton1");
    var sendData=document.querySelector("#sendData");
    var myTokens=document.querySelector(".tokenAmount");
    var chatPrompt=document.querySelector(".chatPrompt");
    // var myCity=document.querySelector(".userCity");

            textarea.addEventListener("keyup", e =>{
        textarea.style.height= `60`
        let scHeight = e.target.scrollHeight/2 +15;
        textarea.style.height= `${scHeight}px`

    })
    chatPageButton.addEventListener('click', async () => {
      voicePage.style.display="none"
      chatPage.style.display="block"
      console.log("chat")
    })
    settingsButton.addEventListener('click', async () => {
      if(settings.style.display=="flex"){
        console.log(settings.style.display)
        settings.style.display="none"
      }else {
        settings.style.display="flex"
      }
      console.log("settings")
    })
    voicePageButton.addEventListener('click', async () => {
      chatPage.style.display="none"
      voicePage.style.display="block"
      console.log("voice")
    })


function createMessageDiv(messageText, backgroundColor, messageType) {
    const div = document.createElement('div');
    div.style.cssText = `margin: 5px; padding: 5px; background-color: ${backgroundColor}; display: flex; align-items: center;`;

    if (messageType === 'Server') {


        
        const btn = document.createElement('button');
        btn.innerText = 'Play Audio';
        btn.onclick = () => {
          const audioSrc = `/audio/${div.id}.mp3`
            const audioElement = new Audio(audioSrc);
            audioElement.play();
        };
        div.appendChild(btn);
    }

    const span = document.createElement('span');
    span.innerText = `${messageText}`;
    div.appendChild(span);

    div.id = `msg-${Date.now()}`;

    return div;
}



sendText.addEventListener('click', async () => {
  let randomBoolean = true
  const message = userInput.value;
  userInput.value = '';

  const userDiv = createMessageDiv(message, '#e6e6e6', 'You');
  chatbox.appendChild(userDiv);
  
  currentResponseDiv = null;  // Reset for the new conversation turn
  
  await fetch('/chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ userInput: message }),
  });

  const eventSource = new EventSource('/events');
  



  eventSource.onmessage = async (event) => {

  if (event.data !== 'undefined') {
    eventSource.addEventListener('end', async () => {
      let entireResponse= ''
      let idToSend= ''
      if(randomBoolean == true){

        entireResponse = currentResponseDiv.querySelector('span').innerText
        idToSend = currentResponseDiv.id;
        console.log(entireResponse)
        console.log(idToSend)
        randomBoolean = false
        await fetch('/send-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                entireResponse: entireResponse,
                divID: idToSend 
            }),
        });
        eventSource.close();
      }else{
        eventSource.close();
      }
    });
        if (!currentResponseDiv) {
            currentResponseDiv = createMessageDiv('', '#f2f2f2', 'Server');
            chatbox.appendChild(currentResponseDiv);
        }

        const span = currentResponseDiv.querySelector('span');
        span.innerText += event.data;
        chatbox.scrollTop = chatbox.scrollHeight;
    }
};

  eventSource.onerror = (error) => {
    console.error('EventSource failed:', error);
    eventSource.close();
  };
});



    sendData.addEventListener("click",()=>{
                
                var obj={
                        voice: dropdownList.value,
                        tokens:myTokens.value,
                        prompt:chatPrompt.value,
                        // city:myCity.value
                    };
                    fetch("/api",{
                    method:"POST",
                    headers:{
                        "Content-type":"application/json"
                    },
                    body:JSON.stringify(obj)
                    })
                    // .then((r)=>r.json()).then((response)=>console.log(response));
    
                })




function generateUniqueId() {
    return `${Date.now()}`;
}

                
recordButton.addEventListener('mousedown', async () => {
  // Start recording logic
  recordedChunks = [];
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream, {mimeType: 'audio/webm;codecs=opus'});

  mediaRecorder.ondataavailable = (e) => {
    recordedChunks.push(e.data);
  };

  mediaRecorder.start();
  // recordButton.disabled = true; // Optionally disable the button while recording
});

recordButton.addEventListener('mouseup', () => {
  // Stop recording logic
  btn.classList.add("aiButton1--loading");
  recordButton.disabled = true;

  mediaRecorder.onstop = async () => {
    const audioBlob = new Blob(recordedChunks, { 'type' : 'audio/webm;codecs=opus' });
    const uniqueId = generateUniqueId();

    const formData = new FormData();
    formData.append('file', audioBlob, 'recording.webm');
    formData.append('uniqueId', uniqueId);

    try {
      const response = await fetch(`/upload`, { method: 'POST', body: formData });
      const data = await response.json();
      
      setTimeout(() => {
        console.log(uniqueId)
        recordButton.classList.remove("aiButton1--loading");
        audio.src = `/audio/${uniqueId}.mp3`; 

        setTimeout(() => {
          btn.classList.remove("aiButton1--loading");
          audio.play();
        }, 100);
        document.querySelector('#playAI').disabled = false;
        recordButton.disabled = false; // Re-enable the button after recording and processing is done
      }, 1000);
    } catch (error) {
      console.error('There was an error!', error);
    }
  };

  mediaRecorder.stop();
});


  //   document.querySelector('#start').onclick = async () => {
  //     recordedChunks = []
  //     const audio = document.querySelector('#aiResponsePlayer');
  //     const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  //     mediaRecorder = new MediaRecorder(stream,{mimeType: 'audio/webm;codecs=opus'});
  //     mediaRecorder.ondataavailable = (e) => {
  //       recordedChunks.push(e.data);
  //     };
  //     mediaRecorder.start();
  //     document.querySelector('#stop').disabled = false;
  //     document.querySelector('#start').disabled = true;
  //     document.querySelector('#playAI').disabled = true;
  //     audio.src = '/';
  //   };

  //   document.querySelector('#stop').onclick = () => {
  //     btn.classList.add("aiButton1--loading");
  //     document.querySelector('#stop').disabled = true;
      
  //     mediaRecorder.onstop = () =>{

  //     const audioBlob = new Blob(recordedChunks, { 'type' : 'audio/webm;codecs=opus' });
  //     const formData = new FormData();
  //     formData.append('file', audioBlob, 'recording.webm');

  //     fetch('https://a08d-173-160-242-66.ngrok-free.app/upload', { method: 'POST', body: formData })
  //       .then(response => response.json())
  //       .then(data => {
  //         setTimeout(function wait() {
  //           btn.classList.remove("aiButton1--loading");
  //           document.querySelector('#playAI').disabled = false;
  //           document.querySelector('#start').disabled = false;
  //           const audio = document.querySelector('#aiResponsePlayer');
  //           audio.src = '/audio/received_audio.mp3'; 
  //           setTimeout(function wait() {
  //             audio.play();
  //           }, 1000)  
  //         }, 1000)
  //       })
  //       .catch((error) => console.error('There was an error!', error));
  //   };
  //   mediaRecorder.stop()
  // }

    document.querySelector('#playAI').onclick = () => {
      const audio = document.querySelector('#aiResponsePlayer'); 
      setTimeout(function wait() {
      audio.play();
    }, 1000)
    };


  </script>
</body>
